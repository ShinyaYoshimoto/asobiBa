name: Cloud Build on Tag

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build:
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v0.2.0
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        export_default_credentials: true

    - name: Extract tag version
      id: extract_tag
      run: |
        TAG_VERSION=${GITHUB_REF#refs/tags/}
        if [[ ! "$TAG_VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "Invalid tag format. Must be v{major}.{minor}.{patch} with numeric values."
          exit 1
        fi
        echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_ENV

    - name: Submit Cloud Build
      run: |
        gcloud builds submit \
        # 本当は、asia-east1 は、asia-northeast1 に変更したい
          --region asia-east1 \
          --config ./mahjong-hono/cloudbuild.yaml \
          --substitutions=_TAG_VERSION=${{ env.TAG_VERSION }}