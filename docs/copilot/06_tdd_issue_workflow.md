# 06_tdd_issue_workflow — Issue からの実装と TDD に関するルール

パッケージ共通：Issue からの実装依頼時のルール（Copilot 向け）

## 適用範囲
- Issue を基に Copilot に実装を依頼する場合、ここに定めるルールは本リポジトリ全体で必須とする。

## 事前要件（Issue 側）
- 実装要求は必ず Issue 番号（例: #123）と Issue の URL を含めること。
- Issue には受け入れ基準（Acceptance criteria）を具体的に列挙すること（期待される入力・出力、エッジケース、性能要件など）。
- もし Issue が不明瞭なら、まず Copilot は「明確化のための質問」を出し、人の回答を待つこと。具体的な要件が得られるまで実装を行わない。

## TDD（テスト駆動開発）ワークフロー（必須）
- 実装は必ず TDD のステップで行うこと：1) 失敗するテスト（Red）を追加、2) 必要最小限の実装でテストを成功させる（Green）、3) リファクタリングしてコード品質を改善（Refactor）。
- Copilot に依頼する際は「まずテストを作ってください。テストが失敗することを示す差分（またはテスト単体の実行結果の期待値）を出してから、次に実装差分を出してください」と明示すること。
- コミット/差分の推奨構成（PR に含める履歴例）:
  - chore(<package>): add failing test for <feature>
  - feat(<package>): implement minimal code to satisfy test
  - refactor(<package>): cleanup code / update types / add docs
- もし一つの PR にまとめる場合でも、出力としては上記の段階を分かるように差分と説明で示すこと（テスト追加部分と実装部分を明確に分ける）。

## 出力要求（Copilot へ指示する際に必須）
- 変更差分は unified diff 形式で出すこと。
- 追加したテストファイル名とテストケース名、失敗時の期待されるメッセージ（テストが Red であることを示す）を明記すること。
- 実装差分と合わせてローカルでの検証手順を示すこと（例: pnpm install && pnpm --filter <package> test など）。
- PR 用の説明文（テンプレート）を生成すること：Issue 参照、変更概要、テスト手順、影響範囲、マイグレーション手順（あれば）。

## テストの粒度とモック方針
- 単体テストはユニットに集中し、外部依存（DB/GCS/外部API）はモックまたはスタブを使うこと。統合が必要なら E2E を別途用意し、実行条件を明記する。
- パッケージごとに標準的なテストフレームワーク（vitest または jest）を使うこと（package.json の設定を参照）。

## DB / Prisma の変更が必要な Issue の扱い
- Prisma schema の変更を伴う場合、Copilot は「schema 変更案（schema.prisma の diff）」「migration 手順（pnpm --filter @asobiba/common prisma:migrate 等）」「prisma:generate 実行箇所」を必ず提示すること。
- 生成済みクライアントの差分は自動的に編集しない。生成物の差分は「生成後に出る差分」として提示する。

## 複数パッケージに跨る変更
- 影響を受けるパッケージを列挙し、可能なら変更をパッケージ単位に分割する案を提示すること。
- ルートでの pnpm -r build / test を通す手順を必ず含めること。

## PR 作成に関する出力（Copilot が PR 文面を出す場合）
- PR のタイトルに Issue 番号を含める（例: "feat(pack): implement X (fixes #123)"）。
- PR 本文は少なくとも次を含める：Issue リンク、変更の要約、追加したテストの一覧、ローカルでの検証手順、影響範囲、マイグレーション手順（必要なら）。
- 自動でマージしてはならない。生成物は必ず人のレビューを経てマージすること。

## 例：Copilot に渡すプロンプト雛形（日本語）
```
Issue #123（URL: ...）の実装を TDD で進めてください。
まず vitest の失敗するユニットテストを追加する差分を unified diff で出して下さい（テストが失敗することが明確にわかる内容にしてください）。
次に、そのテストが通るための最小限の実装差分を提示してください。
最後にリファクタ差分を示し、ローカルでの検証コマンド（pnpm --filter @asobiba/<package> test 等）と PR 用の説明文を出してください。
DB 変更がある場合は prisma schema の差分と migrate/generate の手順も含めてください。
```

## 不明点・曖昧な要件がある場合
- Copilot は勝手に仮定して実装を進めず、まず「実装を進めるための前提（例: デフォルトの挙動は X とする）」を複数提案し、ユーザーに確認を求めること。

## 運用上の注意事項
- Copilot に「PR をそのまま作成してマージする」権限は与えない（自動マージは不可）。Copilot の出力（diff / PR 文面）を人が検査してから CI を通しマージするフローを厳守する。
- 小さな修正でも TDD を崩してはならないが、限定的なドキュメント修正などテスト不要な作業は例外として扱ってよい（ただしその例外は Issue に明示すること）。

## チェックリスト（Issue → Copilot 実装依頼用）
- [ ] Issue に受け入れ基準が書かれている
- [ ] 必要なデータや環境（DB / GCS / env）について説明があるか、またはモックで代替する指示がある
- [ ] Copilot に「まず failing test を作る」ことを明示している
- [ ] PR 用のテンプレート（タイトル・本文）を生成するよう指示している
- [ ] Prisma 変更がある場合、migration 手順を含めるよう指示している
